close all

%For Population-scale COVID-19 Diagnostics Using a Compressed Barcode Space

%Define Params
eps = 0.0001;
b = 100000;
m = 10000;
m3 = 10;
m4 = 96;
m5 = 384;
k1 = 2;
k2 = 3;
k3 = 4; 
k4 = 5;
dstoch1 = 0.01;
dstoch2 = 0.05;
dsynth = 0.01;

%Initialize x-coordinates
x = logspace(-2,2);

n = x*b./100;

%% DeltaK with subpools, m = 10000, used in old preprint

%{
w1 = FPPdeltak(m, 5, 3, n, 0, 0);
w2 = FPPsubpoolk(m, 5, 3, n, 0, 0, m3);
w3 = FPPsubpoolk(m, 5, 3, n, 0, 0, m4);
w4 = FPPsubpoolk(m, 5, 3, n, 0, 0, m5);
%}

w1 = FPPdeltak(m, 5, 3, n, dstoch2, dsynth);
w2 = FPPsubpoolk(m, 5, 3, n, dstoch2, dsynth, m3);
w3 = FPPsubpoolk(m, 5, 3, n, dstoch2, dsynth, m4);
w4 = FPPsubpoolk(m, 5, 3, n, dstoch2, dsynth, m5);

w5 = FNPdeltak(m, 5, 3, n, dstoch2, dsynth);
w6 = FNPsubpoolk(m, 5, 3, n, dstoch2, dsynth, m3);
w7 = FNPsubpoolk(m, 5, 3, n, dstoch2, dsynth, m4);
w8 = FNPsubpoolk(m, 5, 3, n, dstoch2, dsynth, m5);

figure(1)
tiledlayout(1, 2);

x2 = [0.01,100] ;
y2 = [0.002,0.002];
   
nexttile
loglog(x, w5)
hold on
loglog(x, w6)
loglog(x, w7)
loglog(x, w8)
plot(x2,y2,'-r')
title("% Infected vs FNP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0.01, k = 5, k' = 3)")
ylabel("False Negative Probability")
xlabel("% Infected")
legend("FNP_{\Delta k', m_2}, m_2=1", "FNP_{\Delta k', m_2}, m_2=10",...
    "FNP_{\Delta k', m_2}, m_2=96", "FNP_{\Delta k', m_2}, m_2=384",...
    "FNP = 0.002", 'Location', 'SouthWest')
ylim([10^(-6) 1])
grid off

nexttile
loglog(x, w1)
hold on
loglog(x, w2)
loglog(x, w3)
loglog(x, w4)
plot(x2,y2,'-r')
title("% Infected vs FPP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0.01, k = 5, k' = 3)")
ylabel("False Positive Probability")
xlabel("% Infected")
legend("FPP_{\Delta k', m_2}, m_2=1", "FPP_{\Delta k', m_2}, m_2=10",...
    "FPP_{\Delta k', m_2}, m_2=96", "FPP_{\Delta k', m_2}, m_2=384",...
    "FPP = 0.002", 'Location', 'NorthWest')
ylim([10^(-6) 1])
grid off

%% DeltaK with subpools, m = 1000, used in figure

w21 = FPPdeltak(1000, 5, 3, n, 0, 0);
w22 = FPPsubpoolk(1000, 5, 3, n, 0, 0, m3);
w23 = FPPsubpoolk(1000, 5, 3, n, 0, 0, m4);
w24 = FPPsubpoolk(1000, 5, 3, n, 0, 0, m5);

w25 = FNPdeltak(1000, 5, 3, n, dstoch2, dsynth);
w26 = FNPsubpoolk(1000, 5, 3, n, dstoch2, dsynth, m3);
w27 = FNPsubpoolk(1000, 5, 3, n, dstoch2, dsynth, m4);
w28 = FNPsubpoolk(1000, 5, 3, n, dstoch2, dsynth, m5);

figure(2)
tiledlayout(1, 2);

x2 = [0.01,100] ;
y2 = [0.002,0.002];
   
nexttile
loglog(x, w25)
hold on
loglog(x, w26)
loglog(x, w27)
loglog(x, w28)
plot(x2,y2,'-r')
title("% Infected vs FNP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0.01, k = 5, k' = 3)")
ylabel("False Negative Probability")
xlabel("% Infected")
legend("FNP_{\Delta k', m_2}, m_2=1", "FNP_{\Delta k', m_2}, m_2=10",...
    "FNP_{\Delta k', m_2}, m_2=96", "FNP_{\Delta k', m_2}, m_2=384",...
    "FNP = 0.002", 'Location', 'SouthWest')
ylim([10^(-6) 1])
grid off

nexttile
loglog(x, w21)
hold on
loglog(x, w22)
loglog(x, w23)
loglog(x, w24)
plot(x2,y2,'-r')
title("% Infected vs FPP (\Delta_{stoch} = 0, \Delta_{synth} = 0, k = 5, k' = 3)")
ylabel("False Positive Probability")
xlabel("% Infected")
legend("FPP_{\Delta k', m_2}, m_2=1", "FPP_{\Delta k', m_2}, m_2=10",...
    "FPP_{\Delta k', m_2}, m_2=96", "FPP_{\Delta k', m_2}, m_2=384",...
    "FPP = 0.002", 'Location', 'SouthEast')
ylim([10^(-6) 1])
grid off

%% DeltaK with subpools, m = 5000, allows higher error rates

w21 = FPPdeltak(5000, 5, 3, n, 0, 0);
w22 = FPPsubpoolk(5000, 5, 3, n, 0, 0, m3);
w23 = FPPsubpoolk(5000, 5, 3, n, 0, 0, m4);
w24 = FPPsubpoolk(5000, 5, 3, n, 0, 0, m5);

w25 = FNPdeltak(5000, 5, 3, n, dstoch2, dsynth);
w26 = FNPsubpoolk(5000, 5, 3, n, dstoch2, dsynth, m3);
w27 = FNPsubpoolk(5000, 5, 3, n, dstoch2, dsynth, m4);
w28 = FNPsubpoolk(5000, 5, 3, n, dstoch2, dsynth, m5);

figure(3)
tiledlayout(1, 2);

x2 = [0.01,100] ;
y2 = [0.002,0.002];
   
nexttile
loglog(x, w25)
hold on
loglog(x, w26)
loglog(x, w27)
loglog(x, w28)
plot(x2,y2,'-r')
title("% Infected vs FNP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0.01, k = 5, k' = 3)")
ylabel("False Negative Probability")
xlabel("% Infected")
legend("FNP_{\Delta k', m_2}, m_2=1", "FNP_{\Delta k', m_2}, m_2=10",...
    "FNP_{\Delta k', m_2}, m_2=96", "FNP_{\Delta k', m_2}, m_2=384",...
    "FNP = 0.002", 'Location', 'SouthWest')
ylim([10^(-6) 1])
grid off

nexttile
loglog(x, w21)
hold on
loglog(x, w22)
loglog(x, w23)
loglog(x, w24)
plot(x2,y2,'-r')
title("% Infected vs FPP (\Delta_{stoch} = 0, \Delta_{synth} = 0, k = 5, k' = 3)")
ylabel("False Positive Probability")
xlabel("% Infected")
legend("FPP_{\Delta k', m_2}, m_2=1", "FPP_{\Delta k', m_2}, m_2=10",...
    "FPP_{\Delta k', m_2}, m_2=96", "FPP_{\Delta k', m_2}, m_2=384",...
    "FPP = 0.002", 'Location', 'SouthEast')
ylim([10^(-6) 1])
grid off

%% Effect of varying m on FPP and FNP given p = 0.01, k=5, k' = 3
xm = logspace(2,4);
n2 = 0.01*b;
%{
l1 = FPPsubpoolk(xm, 5, 3, n2, 0, 0, 1);
l2 = FPPsubpoolk(xm, 5, 3, n2, 0, 0, m3);
l3 = FPPsubpoolk(xm, 5, 3, n2, 0, 0, m4);
l4 = FPPsubpoolk(xm, 5, 3, n2, 0, 0, m5);
%}

l1 = FPPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, 1);
l2 = FPPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, m3);
l3 = FPPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, m4);
l4 = FPPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, m5);

l5 = FNPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, 1);
l6 = FNPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, m3);
l7 = FNPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, m4);
l8 = FNPsubpoolk(xm, 5, 3, n2, dstoch2, dsynth, m5);

figure(4)
tiledlayout(1, 2);

x3 = [100,10000] ;
y3 = [0.002,0.002];

nexttile
loglog(xm, l5)
hold on
loglog(xm, l6)
loglog(xm, l7)
loglog(xm, l8)
plot(x3,y3,'-r')
title("Barcode 1 Number (m) vs FNP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0.01, k = 5, k' = 3, p=0.01)")
ylabel("False Negative Probability")
xlabel("Barcode 1 Number (m)")
legend("FNP_{\Delta k', m_2}, m_2=1", "FNP_{\Delta k', m_2}, m_2=10",...
    "FNP_{\Delta k', m_2}, m_2=96", "FNP_{\Delta k', m_2}, m_2=384",...
    "FNP = 0.002",'Location', 'NorthEast')
ylim([10^(-6) 1])
grid off

nexttile
loglog(xm, l1)
hold on
loglog(xm, l2)
loglog(xm, l3)
loglog(xm, l4)
plot(x3,y3,'-r')
title("Barcode 1 Number (m) vs FPP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0.01, k = 5, k' = 3, p=0.01)")
ylabel("False Positive Probability")
xlabel("Barcode 1 Number (m)")
legend("FPP_{\Delta k', m_2}, m_2=1", "FPP_{\Delta k', m_2}, m_2=10",...
    "FPP_{\Delta k', m_2}, m_2=96", "FPP_{\Delta k', m_2}, m_2=384",...
    "FPP = 0.002",'Location', 'SouthWest')
ylim([10^(-6) 1])
grid off

%% FPP1-4, FNP1-4

realx = x(1:49);

FPP1 = [0.0, 4.0008001600320064e-07, 4.0008001600320064e-07, 4.0008001600320064e-07, 4.0012003601080325e-07, 4.0012003601080325e-07, 8.003201280512206e-07, 8.003201280512206e-07, 8.0040020010005e-07, 2.001200720432259e-06, 2.4016811768237765e-06, 3.2025620496397114e-06, 4.004004004004004e-06, 4.805766920304365e-06, 5.6078509913879435e-06, 9.616347791245116e-06, 1.6835354243912213e-05, 2.8571428571428574e-05, 4.533600802407221e-05, 7.466880770774789e-05, 0.00013477955207391785, 0.0002216525934861278, 0.0004101841602093187, 0.0007460701330108826, 0.0013835284618490108, 0.002459858442871587, 0.004597648728083511, 0.008384044715447155, 0.015703446869263716, 0.028005119279205487, 0.050208479110928184, 0.08714855072463769, 0.1457351407716371, 0.23213677012098896, 0.3491130490269063, 0.4910297413793104, 0.6441462052349141, 0.7851104904479946, 0.8917863766456784, 0.9566355482119675, 0.9869285276449675, 0.9971357850070721, 0.9995725023916905, 0.9999544513457558, 0.9999986870178893, 1.0, 1.0, 1.0, 1.0];
FPP2 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.008417677121956e-07, 0.0, 8.02407221664995e-07, 8.028904054596548e-07, 1.6069097117605706e-06, 3.216726980297547e-06, 5.635503673140787e-06, 1.0378879484079001e-05, 1.897456600726685e-05, 2.5176946410515672e-05, 5.006587615283268e-05, 9.634146341463415e-05, 0.00016194166836630636, 0.0002768506194327839, 0.0004889895040131715, 0.0008968944099378882, 0.0016304483837330552, 0.003130562861651762, 0.005875784324151866, 0.011034051724137931, 0.020562588982586793, 0.03758306334487767, 0.06700847166571265, 0.11559412250678626, 0.19069645703077112, 0.29612575543268616, 0.4313338800054667, 0.5857632357290743, 0.7363131462333825, 0.858544370860927, 0.938709512761021, 0.9796565592084264, 0.995047285464098];
FPP3 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.020908725371934e-07, 4.0253597665291334e-07, 4.0306328093510685e-07, 8.074283407347598e-07, 2.0222446916076845e-07, 4.053917097395358e-07, 8.130081300813008e-07, 3.2633081786661228e-06, 6.143135046585441e-06, 5.7625025725457915e-06, 1.2422360248447203e-05, 1.897810218978102e-05, 3.7664387164650184e-05, 5.6577687971923845e-05, 0.00010538793103448276, 0.000191654802321761, 0.00032309239191151824, 0.0005989696622781911, 0.0011174318423226722, 0.0021529974255240897, 0.0041265269384081265, 0.007989613229465627, 0.015120378586217096, 0.02860905957656327, 0.052033301797540205, 0.09154106728538283, 0.15570794765400572, 0.2498470519556334];
FPP4 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.2013936165952505e-06, 4.0055677391574286e-07, 2.0033656542992223e-06, 2.8056955619908405e-06, 3.2078592551751786e-06, 6.8201193520886615e-06, 1.5655734414515674e-05, 1.5667369689665563e-05, 3.9404113306929896e-05, 6.641576267434137e-05, 0.00011325507582245954, 0.00021273804357698636, 0.0003692581470359248, 0.0007333238745768897, 0.0013934959349593502, 0.0026772986366741785, 0.00504187570390089, 0.009713544882084209, 0.01855619733763948, 0.034565455398571504, 0.06232531717477751, 0.10916882895912206, 0.18083251619020937, 0.2842722912149288, 0.41788109653924366, 0.5719499490561071, 0.7229329084793767, 0.8481099302516578, 0.9324670181303846, 0.9768198652508437, 0.9942382255083178, 0.999002790086985, 0.9998925280505574, 0.9999944316837195, 1.0, 1.0];

FNP1 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.302325581395348e-05, 7.692307692307693e-05, 6.349206349206349e-05, 5.263157894736842e-05, 0.0, 0.0, 3.007518796992481e-05, 0.0, 0.0, 0.0, 0.0, 2.3529411764705884e-05, 1.951219512195122e-05, 8.08080808080808e-06, 6.700167504187605e-06, 5.555555555555556e-06, 4.602991944764097e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
FNP2 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.302325581395348e-05, 7.692307692307693e-05, 6.349206349206349e-05, 0.0, 4.3478260869565214e-05, 3.6363636363636364e-05, 9.022556390977444e-05, 0.0001, 6.185567010309279e-05, 6.86695278969957e-05, 4.2553191489361704e-05, 5.882352941176471e-05, 4.878048780487805e-05, 4.848484848484849e-05, 3.350083752093802e-05, 3.3333333333333335e-05, 2.3014959723820486e-05, 1.9065776930409914e-05, 2.8458498023715415e-05, 2.357563850687623e-05, 8.681497558328811e-06, 7.197480881691408e-06, 1.4908684308609764e-06, 1.2353304508956147e-06, 1.0238034297414896e-06, 0.0, 0.0, 0.0, 0.0];
FNP3 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.302325581395348e-05, 7.692307692307693e-05, 6.349206349206349e-05, 5.263157894736842e-05, 4.3478260869565214e-05, 3.6363636363636364e-05, 9.022556390977444e-05, 7.500000000000001e-05, 8.247422680412371e-05, 5.150214592274678e-05, 5.673758865248227e-05, 8.235294117647058e-05, 7.804878048780487e-05, 7.272727272727273e-05, 7.370184254606366e-05, 7.222222222222223e-05, 4.602991944764097e-05, 5.7197330791229736e-05, 5.612648221343873e-05, 4.977079240340537e-05, 3.581117742810635e-05, 2.789023841655421e-05, 2.2363026462914646e-05, 1.3279802347127858e-05, 9.214230867673407e-06, 5.938494167550371e-06, 4.21792618629174e-06, 5.82495995340032e-07, 0.0];
FNP4 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00013559322033898305, 0.0002247191011235955, 0.00018604651162790697, 7.722007722007723e-05, 0.00012779552715654952, 0.00010596026490066225, 8.781558726673985e-05, 7.279344858962693e-05, 9.04977375565611e-05, 5e-05, 4.142931123770067e-05, 0.0, 0.0, 0.0, 9.768009768009767e-06, 1.6187778227438285e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];

figure(5)
tiledlayout(1, 2);

x2 = [0.01,100] ;
y2 = [0.002,0.002];
y3 = [0.0000332222, 0.0000332222];

nexttile
semilogx(realx, FNP1)
hold on
semilogx(realx, FNP2)
semilogx(realx, FNP3)
semilogx(realx, FNP4)
plot(x2,y2,'-r')
% plot(x2,y3,'-b')
title("% Infected vs FNP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0, \Delta_{switch} = 0.02, k_{12}' = 5)")
ylabel("False Negative Probability")
xlabel("% Infected")
legend("m_1=m_2=96, m_3=10", "m_1=m_2=192, m_3=10",...
    "m_1=m_2=384, m_3=10","m_1=m_2=384, m_3=1",...
    "FNP = 0.002", 'Location', 'NorthWest')
ylim([0 0.01])
grid off

nexttile
semilogx(realx, FPP1)
hold on
semilogx(realx, FPP2)
semilogx(realx, FPP3)
semilogx(realx, FPP4)
plot(x2,y2,'-r')
title("% Infected vs FPP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0, \Delta_{switch} = 0.02, k_{12}' = 5)")
ylabel("False Positive Probability")
xlabel("% Infected")
legend("m_1=m_2=96, m_3=10", "m_1=m_2=192, m_3=10",...
    "m_1=m_2=384, m_3=10","m_1=m_2=384, m_3=1",...
    "FNP = 0.002", 'Location', 'NorthWest')
ylim([0 0.01])
grid off

%% FPP5-8, FNP5-8

realx = x(1:49);

FNP5 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00016, 0.00013333333333333334, 0.0001111111111111111, 0.00018604651162790697, 0.00015384615384615385, 0.00012698412698412698, 0.00015789473684210527, 0.00030434782608695655, 0.0002909090909090909, 0.0002706766917293233, 0.000225, 0.00022680412371134018, 0.0001373390557939914, 0.0001276595744680851, 0.00016470588235294116, 0.00010731707317073172, 7.272727272727273e-05, 7.370184254606366e-05, 6.111111111111111e-05, 4.1426927502876876e-05, 1.1439466158245948e-05, 6.324110671936759e-06, 2.6195153896529145e-06, 2.1703743895822028e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
FNP6 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00013333333333333334, 0.0002222222222222222, 0.00027906976744186045, 0.00015384615384615385, 0.00019047619047619045, 0.00015789473684210527, 0.0003478260869565217, 0.00032727272727272726, 0.00042105263157894734, 0.000375, 0.0004123711340206185, 0.00034334763948497857, 0.0003120567375886525, 0.00037647058823529414, 0.0003219512195121951, 0.0002909090909090909, 0.00029480737018425457, 0.0002555555555555556, 0.00023475258918296892, 0.00017921830314585318, 0.00018577075098814228, 0.00015651604453176165, 0.00011068909386869236, 8.816914080071976e-05, 5.814386880357808e-05, 4.20012353304509e-05, 2.1499872024571278e-05, 9.331919406150584e-06, 4.92091388400703e-06, 1.164991990680064e-06, 4.826837214914928e-07];
FNP7 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00016, 0.00013333333333333334, 0.0002222222222222222, 0.00027906976744186045, 0.0003076923076923077, 0.00031746031746031746, 0.0002631578947368421, 0.0003913043478260869, 0.0002909090909090909, 0.00042105263157894734, 0.00044999999999999993, 0.0004948453608247423, 0.0004291845493562232, 0.00041134751773049644, 0.00047058823529411766, 0.00044878048780487806, 0.000509090909090909, 0.0004824120603015075, 0.0005, 0.00047525891829689295, 0.00039656816015252625, 0.00040474308300395256, 0.0003516699410609038, 0.0003060227889310906, 0.000288349077822762, 0.00024748415952292207, 0.00020506485484867205, 0.00016457640133094443, 0.00011431601272534464, 8.330404217926187e-05, 4.878403960972769e-05, 2.4496198865693258e-05];
FNP8 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0012903225806451613, 0.0010526315789473684, 0.0008888888888888889, 0.0007272727272727272, 0.0006060606060606061, 0.0005, 0.00041666666666666664, 0.0003448275862068965, 0.00028776978417266187, 0.0002380952380952381, 0.00039408866995073894, 0.000326530612244898, 0.0002711864406779661, 0.0005617977528089887, 0.0005581395348837209, 0.0006177606177606178, 0.0005111821086261981, 0.0006357615894039735, 0.0005268935236004391, 0.000545950864422202, 0.0005128205128205128, 0.0005, 0.0004764370792335577, 0.0004291845493562231, 0.00032716927453769557, 0.0002592810842663524, 0.0001855921855921856, 0.00017806556050182113, 0.00016096579476861168, 0.00012783104071140757, 8.289201013124569e-05, 4.579278763594733e-05, 1.897383192347221e-05, 1.3101867016049786e-05, 4.34286955105586e-06, 1.799370220422852e-06, 1.4910351511536885e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];

FPP5 = [0.0, 4.0008001600320064e-07, 4.0008001600320064e-07, 4.0008001600320064e-07, 4.0012003601080325e-07, 4.0012003601080325e-07, 4.001600640256103e-07, 4.001600640256103e-07, 4.00200100050025e-07, 4.0024014408645187e-07, 4.002801961372961e-07, 8.006405124099278e-07, 1.6016016016016016e-06, 1.2014417300760913e-06, 2.403364710594833e-06, 2.804768105779826e-06, 2.805892373985369e-06, 3.6090225563909775e-06, 5.616850551654964e-06, 1.0036130068245684e-05, 8.838003414683137e-06, 1.80940892641737e-05, 3.461809399215054e-05, 7.224909310761791e-05, 0.0001401897456600727, 0.0002642062689585439, 0.0005795074490726666, 0.0011959349593495933, 0.002595553742606567, 0.005293437084058565, 0.011232146532208272, 0.022698136645962735, 0.044976016684045876, 0.08483913729615992, 0.1513414867595448, 0.2524893318965517, 0.3908910305552513, 0.554751983018657, 0.7179869490555238, 0.8517967661985129, 0.9383008458992276, 0.9804491449144914, 0.9955607489408228, 0.9993206152026027, 0.9999435417692435, 0.999996215704825, 0.999999071925754, 1.0, 1.0];
FPP6 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.0306328093510685e-07, 8.074283407347598e-07, 8.088978766430738e-07, 1.6215668389581432e-06, 4.471544715447154e-06, 1.1829492147664694e-05, 2.3343913177024672e-05, 3.529532825684297e-05, 7.577639751552797e-05, 0.00015610010427528676, 0.0003324566017885323, 0.0007180687014782517, 0.0015800646551724137, 0.003479356039864199, 0.007443078985588202, 0.015663880938752147, 0.03211117667886226, 0.06335981365698173, 0.11771968625433972, 0.2048828754954216, 0.3305742383910086, 0.4884267191859511, 0.6578177861873227, 0.8073723897911833, 0.9127468879668051, 0.9700788091068302];
FPP7 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.037141703673799e-07, 0.0, 0.0, 0.0, 0.0, 4.095423364390294e-07, 4.1160732661041366e-07, 4.1407867494824017e-07, 1.2513034410844628e-06, 0.0, 2.126980750824205e-06, 4.741379310344828e-06, 9.856532690833425e-06, 1.9215730086023902e-05, 3.663423010875787e-05, 9.123096896022662e-05, 0.00020644844918474932, 0.00043615790150443616, 0.001022960229602296, 0.0022568766637089616, 0.005050713934022648, 0.010894039735099338, 0.022999767981438518, 0.04700127673156719, 0.08998657326328079];
FPP8 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.0118349129933303e-07, 0.0, 4.017274279401426e-07, 1.2062483665386705e-06, 1.2075593213516612e-06, 5.2395586679429695e-06, 1.0899292555177668e-05, 2.103113214224326e-05, 5.35095364533717e-05, 0.00011260162601626017, 0.000259409191487626, 0.0005782737790519094, 0.0013067456887681608, 0.0029120344492060534, 0.006558156509045412, 0.013955269414462748, 0.02914883661576417, 0.0581951014514617, 0.10983682677355061, 0.1941361513885475, 0.3167487492988059, 0.4719915029208711, 0.6404687480846786, 0.7929288928892888, 0.9035934019378731, 0.965729833641405, 0.9909975381585425, 0.9983674859510699, 0.9998013967193334, 0.9999948938886228, 1.0];

figure(6)
tiledlayout(1, 2);

x2 = [0.01,100] ;
y2 = [0.002,0.002];
y3 = [0.00064257469, 0.00064257469];

nexttile
semilogx(realx, FNP5)
hold on
semilogx(realx, FNP6)
semilogx(realx, FNP7)
semilogx(realx, FNP8)
plot(x2,y2,'-r')
%plot(x2,y3,'-b')
title("% Infected vs FNP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0, \Delta_{switch} = 0.02, k_{12}' = 6)")
ylabel("False Negative Probability")
xlabel("% Infected")
legend("m_1=m_2=96, m_3=10", "m_1=m_2=192, m_3=10",...
    "m_1=m_2=384, m_3=10","m_1=m_2=384, m_3=1",...
    "FNP = 0.002", 'Location', 'NorthWest')
ylim([0 0.01])
grid off

nexttile
semilogx(realx, FPP5)
hold on
semilogx(realx, FPP6)
semilogx(realx, FPP7)
semilogx(realx, FPP8)
plot(x2,y2,'-r')
title("% Infected vs FPP (\Delta_{stoch} = 0.05, \Delta_{synth} = 0, \Delta_{switch} = 0.02, k_{12}' = 6)")
ylabel("False Positive Probability")
xlabel("% Infected")
legend("m_1=m_2=96, m_3=10", "m_1=m_2=192, m_3=10",...
    "m_1=m_2=384, m_3=10","m_1=m_2=384, m_3=1",...
    "FNP = 0.002", 'Location', 'NorthWest')
ylim([0 0.01])
grid off

%% Functions 

%Functions for FNP and FPP with k' out of k model
function f = FPPdeltak(m, k, ktwo, n, dstoch, dsynth)
    ftwo = 0;
    for s =ktwo:k
        ftwo = ftwo+nchoosek(k, s).*((1-dsynth).*(1-(1-(1-dstoch)./m).^(k*n))).^(s)...
        .*(dsynth+(1-dsynth)*(1-(1-dstoch)./m).^(k*n)).^(k-s);
    end
    f = ftwo;
end

function g = FNPdeltak(m, k, ktwo, n, dstoch, dsynth)
    gtwo = 1;
    for s=ktwo:k
        gtwo = gtwo-nchoosek(k,s)*((1-dsynth).*(1-dstoch.*(1-(1-dstoch)./m)...
            .^(k*(n-1)))).^(s).*(dsynth+(1-dsynth).*dstoch.*...
            (1-(1-dstoch)./m).^(k*(n-1))).^(k-s);
    end
    g = gtwo;
end

%Functions for FNP and FPP with subpools

function m = FNPsubpoolk(m, k, ktwo, n, dstoch, dsynth, m2)
    m = FNPdeltak(m, k, ktwo, n/m2, dstoch, dsynth);
end

function n = FPPsubpoolk(m, k, ktwo, n, dstoch, dsynth, m2)
    n = FPPdeltak(m, k, ktwo, n/m2, dstoch, dsynth);
end
